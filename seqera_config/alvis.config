// Alvis Config Profile
// Docs: https://www.c3se.chalmers.se/documentation/alvis/
// Alvis is a GPU cluster at Chalmers/C3SE
// Note: Alvis does NOT allow direct --mem requests; memory comes from the allocated node
params {
    config_profile_description   = 'Alvis GPU cluster profile at Chalmers C3SE'
    config_profile_contact       = 'C3SE Support'
    config_profile_url           = 'https://www.c3se.chalmers.se/documentation/alvis/'
    project                      = 'NAISS2025-22-885'
    clusterOptions               = null
    schema_ignore_params         = "genomes,input_paths,cluster-options,clusterOptions,project"
    validationSchemaIgnoreParams = "genomes,input_paths,cluster-options,clusterOptions,project,schema_ignore_params"
    save_reference               = true
    // Alvis resource defaults
    max_memory                   = 256.GB
    max_cpus                     = 16
    max_time                     = 168.h  // 7 days max on Alvis
    // GPU settings
    gpus                         = 'T4:1' // 1 T4 GPU per node
    ignore_params_list           = [
        "cluster-options",
        "clusterOptions",
        "clusterName",
        "genomes",
        "gpus",
        "ignore_params_list",
        "input_paths",
        "max_cpus",
        "max_memory",
        "max_time",
        "project",
        "schema_ignore_params",
        "validationSchemaIgnoreParams",
    ]
}

// nf-schema/nf-validation settings
validation {
    ignoreParams = params.ignore_params_list
}
params.schema_ignore_params = params.ignore_params_list.join(",")
params.validationSchemaIgnoreParams = params.ignore_params_list.join(",")

singularity {
    enabled      = true
    envWhitelist = 'TMPDIR'
}

executor {
    $slurm {
        account = params.project
    }
}

// Alvis hardware: https://www.c3se.chalmers.se/documentation/alvis/
// Alvis rejects --mem; use -C MEM512|MEM1536 for high-memory nodes if needed
process {
    memory = null
    // Override pipeline memory - Alvis forbids --mem
    withLabel: 'medium_mem' { memory = null }
    withLabel: 'large_mem' { memory = null }
    withName: 'CELLPOSE' { memory = null }
    // codebook_expanded.csv and extra_codebook_expanded.csv use lowercase 'code' column (not 'Code')
    withName: 'IMAGING_POSTCODE' {
        memory = null
        ext.args = "--codebook_target_col Gene --codebook_code_col code --coding_col_prefix 'cycle\\d_channel\\d_+'"
    }
    withName: 'EXTRA_POSTCODE' {
        memory = null
        ext.args = "--codebook_target_col Gene --codebook_code_col code --coding_col_prefix 'cycle\\d_channel\\d_+'"
    }
    withName: 'TO_SPATIALDATA' { memory = null }
    withName: 'MERGEOUTLINES' { memory = null }
    withName: 'IMAGING_MICROALIGNER' { memory = null }
    withName: 'IMAGING_TILEDSPOTIFLOW' { memory = null }
    withName: 'IMAGING_MERGEPEAKS' { memory = null }
    withName: 'IMAGING_CONCATENATEWKTS' { memory = null }
    withName: 'EXTRACT_PEAK_PROFILE' { memory = null }
    withName: 'EXTRA_EXTRACT_PEAK_PROFILE' { memory = null }
    withName: 'IMAGING_CELLPOSE' { memory = null }
    withName: 'MERGEPEAKS' { memory = null }
    withName: 'RUN_QC_DOWNSTREAM' { memory = null }
    resourceLimits = [
        cpus: 16,
        time: 168.h,
    ]
    clusterOptions = {
        def opts = ["-A ${params.project}", "-p alvis"]
        if (params.clusterOptions) {
            opts << params.clusterOptions
        }
        if (params.gpus) {
            opts << "--gpus-per-node=${params.gpus}"
        }
        opts.join(" ")
    }
    executor = 'slurm'
    scratch  = '$TMPDIR'
}

// Profile for different GPU types on Alvis
profiles {
    // T4 GPUs - good for inference and smaller workloads
    t4 {
        params {
            config_profile_description = 'Alvis T4 GPU profile'
            gpus                       = 'T4:1'
        }
    }
    // V100 GPUs - high performance training
    v100 {
        params {
            config_profile_description = 'Alvis V100 GPU profile'
            gpus                       = 'V100:1'
        }
    }
    // A40 GPUs
    a40 {
        params {
            config_profile_description = 'Alvis A40 GPU profile'
            gpus                       = 'A40:1'
        }
    }
    // A100 GPUs - latest generation, highest performance
    a100 {
        params {
            config_profile_description = 'Alvis A100 GPU profile'
            gpus                       = 'A100:1'
            max_memory                 = 512.GB
        }
    }
    // Development/testing profile
    devel {
        params {
            config_profile_description = 'Testing & development profile for Alvis'
            max_memory                 = 64.GB
            max_time                   = 1.h
            gpus                       = 'T4:1'
        }
        executor.queueSize = 1
        process {
            resourceLimits = [
                cpus: 4,
                time: 1.h,
            ]
        }
    }
}